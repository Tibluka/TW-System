<!-- pages/authorized/production-orders/production-order-modal/production-order-modal.component.html -->

<!-- üìä LOADING INICIAL -->
<div *ngIf="isLoading" class="loading-container">
    <ds-spinner size="32px"></ds-spinner>
    <p class="body label mt-16">Carregando dados...</p>
</div>

<!-- üìù FORMUL√ÅRIO PRINCIPAL -->
<form *ngIf="!isLoading" [formGroup]="productionOrderForm" (ngSubmit)="onSave()" class="production-order-form">

    <!-- ============================================ -->
    <!-- SE√á√ÉO: BUSCA DO DESENVOLVIMENTO -->
    <!-- ============================================ -->
    <div class="form-section mb-32">
        <h3 class="section-title mb-24">Desenvolvimento</h3>

        <div class="form-row mb-16">
            <!-- üîç REFER√äNCIA INTERNA -->
            <div class="form-field">
                <ds-input label="Refer√™ncia Interna do Desenvolvimento *" placeholder="Ex: 25ABC0001"
                    formControlName="internalReference" [invalid]="isFieldInvalid('internalReference')"
                    [errorMessage]="getFieldErrorMessage('internalReference')" [fullWidth]="true" [required]="true"
                    [disabled]="isEditMode" (input)="onInternalReferenceChange()">
                </ds-input>
            </div>
        </div>

        <!-- üîç ESTADO DA BUSCA -->
        <div class="search-status" *ngIf="!isEditMode">

            <!-- Loading da busca -->
            <div class="search-loading" *ngIf="searchingDevelopment">
                <ds-spinner size="16px"></ds-spinner>
                <span class="body label ml-8">Buscando desenvolvimento...</span>
            </div>

            <!-- Desenvolvimento n√£o encontrado -->
            <div class="search-not-found" *ngIf="developmentNotFound && !searchingDevelopment">
                <ds-icon icon="fa-solid fa-triangle-exclamation" color="tertiary" fontSize="16px"></ds-icon>
                <span class="body tertiary ml-8">Desenvolvimento n√£o encontrado</span>
            </div>

            <!-- Desenvolvimento encontrado -->
            <div class="development-found" *ngIf="developmentFound && !searchingDevelopment">
                <div class="development-card">
                    <div class="development-header">
                        <ds-icon icon="fa-solid fa-check-circle" color="primary" fontSize="20px"></ds-icon>
                        <div class="development-info">
                            <h4 class="input-label primary-dark">{{ developmentFound.internalReference }}</h4>
                            <p class="placeholder">{{ developmentFound.description }}</p>
                        </div>
                    </div>

                    <div class="development-details">
                        <!-- Cliente -->
                        <div class="detail-item">
                            <span class="detail-label">Cliente:</span>
                            <span class="detail-value">{{ developmentFound.client?.companyName || 'N/A' }}</span>
                        </div>

                        <!-- Refer√™ncia do Cliente -->
                        <div class="detail-item" *ngIf="developmentFound.clientReference">
                            <span class="detail-label">Ref. Cliente:</span>
                            <span class="detail-value">{{ developmentFound.clientReference }}</span>
                        </div>

                        <!-- Tipos de Produ√ß√£o -->
                        <div class="detail-item">
                            <span class="detail-label">Produ√ß√£o:</span>
                            <div class="production-types">
                                <span class="production-badge rotary"
                                    *ngIf="developmentFound.productionType?.rotary?.enabled">
                                    Rotativa ({{ formatCurrency(developmentFound.productionType.rotary.negotiatedPrice
                                    || 0) }})
                                </span>
                                <span class="production-badge localized"
                                    *ngIf="developmentFound.productionType?.localized?.enabled">
                                    Localizada ({{
                                    formatCurrency(developmentFound.productionType.localized.negotiatedPrice || 0) }})
                                </span>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="status-badge" [ngClass]="'status-' + developmentFound.status">
                                {{ developmentFound.status }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- SE√á√ÉO: INFORMA√á√ïES DA PRODU√á√ÉO -->
    <!-- ============================================ -->
    <div class="form-section mb-32" *ngIf="developmentFound || isEditMode">
        <h3 class="section-title mb-24">Informa√ß√µes da Produ√ß√£o</h3>

        <!-- Linha: Tipo de Produ√ß√£o, Quantidade, Tipo de Tecido -->
        <div class="form-row three-columns mb-24">

            <!-- üè≠ TIPO DE PRODU√á√ÉO -->
            <div class="form-field">
                <ds-select label="Tipo de Produ√ß√£o *" formControlName="productionType" [options]="productionTypeOptions"
                    [invalid]="isFieldInvalid('productionType')" [errorMessage]="getFieldErrorMessage('productionType')"
                    [fullWidth]="true" [required]="true">
                </ds-select>
            </div>

            <!-- üìè QUANTIDADE DE METROS -->
            <div class="form-field">
                <ds-input label="Quantidade (metros) *" placeholder="Ex: 100.5" type="number" step="0.1" min="0.1"
                    formControlName="quantity" [invalid]="isFieldInvalid('quantity')"
                    [errorMessage]="getFieldErrorMessage('quantity')" [fullWidth]="true" [required]="true">
                </ds-input>
            </div>

            <!-- üßµ TIPO DE TECIDO -->
            <div class="form-field">
                <ds-input label="Tipo de Tecido *" placeholder="Ex: Algod√£o, Poli√©ster..." formControlName="fabricType"
                    [invalid]="isFieldInvalid('fabricType')" [errorMessage]="getFieldErrorMessage('fabricType')"
                    [fullWidth]="true" [required]="true">
                </ds-input>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- SE√á√ÉO: CONFIGURA√á√ïES ADICIONAIS -->
    <!-- ============================================ -->
    <div class="form-section mb-32" *ngIf="developmentFound || isEditMode">
        <h3 class="section-title mb-24">Configura√ß√µes</h3>

        <div class="form-row two-columns mb-24">

            <!-- üß™ PILOTO -->
            <div class="form-field checkbox-field">
                <label class="checkbox-container">
                    <input type="checkbox" formControlName="pilot" class="checkbox-input">
                    <span class="checkbox-label input-label primary-dark">
                        Esta √© uma produ√ß√£o piloto
                    </span>
                    <span class="checkbox-description placeholder">
                        Marque se esta ordem √© para produ√ß√£o de amostra/piloto
                    </span>
                </label>
            </div>

            <!-- üö® PRIORIDADE -->
            <div class="form-field">
                <ds-select label="Prioridade *" formControlName="priority" [options]="priorityOptions"
                    [invalid]="isFieldInvalid('priority')" [errorMessage]="getFieldErrorMessage('priority')"
                    [fullWidth]="true" [required]="true">
                </ds-select>
            </div>
        </div>

        <!-- üìä STATUS (apenas em modo edi√ß√£o) -->
        <div class="form-row mb-24" *ngIf="isEditMode">
            <div class="form-field">
                <ds-select label="Status" formControlName="status" [options]="statusOptions" [fullWidth]="true">
                </ds-select>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- SE√á√ÉO: OBSERVA√á√ïES -->
    <!-- ============================================ -->
    <div class="form-section mb-32" *ngIf="developmentFound || isEditMode">
        <h3 class="section-title mb-24">Observa√ß√µes</h3>

        <div class="form-row mb-24">
            <!-- üìù OBSERVA√á√ïES -->
            <div class="form-field full-width">
                <ds-textarea label="Observa√ß√µes"
                    placeholder="Adicione observa√ß√µes sobre a produ√ß√£o, instru√ß√µes especiais, etc..."
                    formControlName="observations" [rows]="4" [fullWidth]="true">
                </ds-textarea>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- A√á√ïES DO FORMUL√ÅRIO -->
    <!-- ============================================ -->
    <div class="form-actions" *ngIf="developmentFound || isEditMode">
        <!-- ‚ùå BOT√ÉO CANCELAR -->
        <ds-button label="Cancelar" variant="ghost" type="button" (onClick)="onCancel()" [disabled]="isSaving">
        </ds-button>

        <!-- üíæ BOT√ÉO SALVAR -->
        <ds-button [label]="saveButtonLabel" variant="fill" type="submit" icon="fa-solid fa-floppy-disk"
            [isLoading]="isSaving"
            [disabled]="productionOrderForm.invalid || isSaving || (!developmentFound && !isEditMode)">
        </ds-button>
    </div>

</form>