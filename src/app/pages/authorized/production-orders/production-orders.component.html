<div class="production-orders-container">
    <!-- ‚ú® Usando vari√°veis do sistema: mb-48 ao inv√©s de margin-bottom: 48px -->
    <h1 class="title-semibold primary-dark mb-48">Ordens de produ√ß√£o</h1>

    <div class="search-input">
        <div class="w-100">
            <ds-input label="Buscar ordem de produ√ß√£o" placeholder="Digite refer√™ncia, tipo de tecido ou observa√ß√µes..."
                icon="fa-solid fa-magnifying-glass" iconPosition="left" [(ngModel)]="currentFilters.search"
                (input)="onSearchChange()" width="100%">
            </ds-input>
        </div>

        <div class="w-100">
            <ds-select label="Filtrar por Status" [options]="statusOptions" [(ngModel)]="currentFilters.status"
                (ngModelChange)="onStatusFilterChange()" width="100%">
            </ds-select>
        </div>

        <ds-button label="Nova Ordem de Produ√ß√£o" variant="fill" icon="fa-solid fa-plus"
            (onClickEmitter)="createProductionOrder()">
        </ds-button>
    </div>

    <div class="results mt-32">
        <ds-table emptyMessage="Nenhuma ordem de produ√ß√£o encontrada" [showPagination]="true"
            [pageSize]="currentFilters.limit" [totalPages]="pagination?.totalPages"
            [currentPage]="pagination?.currentPage || 1" (pageChanged)="onPageChange($event)"
            [loadingData]="shouldShowSpinner">

            <!-- Cabe√ßalho da tabela -->
            <ds-table-row [isHeader]="true">
                <ds-table-cell [isHeader]="true" align="left">Imagem</ds-table-cell>
                <ds-table-cell [isHeader]="true" align="left">Refer√™ncia Interna</ds-table-cell>
                <ds-table-cell [isHeader]="true" align="left">Refer√™ncia do Cliente</ds-table-cell>
                <ds-table-cell [isHeader]="true" align="left">Cliente</ds-table-cell>
                <ds-table-cell [isHeader]="true" align="left">Tipo de Produ√ß√£o</ds-table-cell>
                <ds-table-cell [isHeader]="true" align="left">Tecido</ds-table-cell>
                <ds-table-cell [isHeader]="true" align="center">Status</ds-table-cell>
                <ds-table-cell [isHeader]="true" align="center">A√ß√µes</ds-table-cell>
            </ds-table-row>

            <!-- ‚ú® DADOS DAS ORDENS DE PRODU√á√ÉO -->
            <ds-table-row *ngFor="let productionOrder of productionOrders" [clickable]="true" [data]="productionOrder"
                (rowClick)="onProductionOrderClick(productionOrder)">

                <!-- Imagem -->
                <ds-table-cell align="left">
                    <div class="image-cell">
                        <img *ngIf="productionOrder.development?.pieceImage?.url"
                            [src]="productionOrder.development?.pieceImage?.url"
                            [alt]="productionOrder.development?.description || 'Imagem do desenvolvimento'"
                            class="development-image">
                        <div *ngIf="!productionOrder.development?.pieceImage?.url" class="no-image">
                            <ds-icon icon="fa-solid fa-image" color="label" fontSize="24px"></ds-icon>
                        </div>
                    </div>
                </ds-table-cell>

                <!-- Refer√™ncia Interna -->
                <ds-table-cell align="left">
                    <span class="body primary-dark">
                        <span class="body primary-dark font-weight-medium">{{
                            productionOrder.internalReference }}</span>
                        <ds-icon (click)="copy($event, productionOrder.internalReference)" class="ml-4"
                            cursorType="pointer" icon="fa-regular fa-clipboard" fontSize="16px" />
                    </span>
                </ds-table-cell>

                <!-- Refer√™ncia do Cliente -->
                <ds-table-cell align="left">
                    <span class="body primary-dark">
                        {{ productionOrder.development?.clientReference || '-' }}
                    </span>
                </ds-table-cell>

                <!-- Cliente -->
                <ds-table-cell align="left">
                    <div class="client-cell" *ngIf="productionOrder.development?.client">
                        <div class="body primary-dark">
                            {{ productionOrder.development?.client?.companyName }}
                        </div>
                        <div class="placeholder" *ngIf="productionOrder.development?.client?.acronym">
                            {{ productionOrder.development?.client?.acronym }}
                        </div>
                    </div>
                    <span class="body label" *ngIf="!productionOrder.development?.client">
                        Cliente n√£o encontrado
                    </span>
                </ds-table-cell>

                <!-- Tipo de Produ√ß√£o -->
                <ds-table-cell align="left">
                    <span class="body primary-dark" *ngIf="productionOrder.productionType.type === 'rotary'">
                        Rotativo
                    </span>
                    <span class="body primary-dark" *ngIf="productionOrder.productionType.type === 'localized'">
                        Localizado
                    </span>
                    <p class="body label" *ngIf="productionOrder.productionType.type === 'rotary'">
                        {{productionOrder.productionType.meters}}m</p>
                </ds-table-cell>

                <!-- Tecido -->
                <ds-table-cell align="left">
                    <span class="body primary-dark">{{ productionOrder.fabricType || '-' }}</span>
                </ds-table-cell>

                <!-- Status -->
                <ds-table-cell align="center">
                    <ds-badge [text]="getStatusLabel(productionOrder.status)" [status]="productionOrder.status"
                        entityType="production-order" />

                </ds-table-cell>

                <!-- A√ß√µes -->
                <ds-table-cell align="center">
                    <ds-action-menu [items]="actionMenuItems"
                        (itemSelected)="onActionMenuSelect(productionOrder, $event)">
                    </ds-action-menu>
                </ds-table-cell>

            </ds-table-row>
        </ds-table>
    </div>
</div>

<!-- üé≠ MODAL -->
<!-- Modal s√≥ renderiza o conte√∫do quando estiver vis√≠vel -->
<ds-modal *ngIf="isModalOpen" modalId="production-order-modal" (modalClosed)="onModalClosed($event)">
    <!-- S√≥ renderiza app-production-order-modal quando o modal est√° realmente aberto -->
    <app-production-order-modal [productionOrderId]="selectedProductionOrderId"></app-production-order-modal>
</ds-modal>

<!-- Componente de atualiza√ß√£o de status -->
<ds-status-updater *ngIf="selectedProductionOrderForStatusUpdate" #statusUpdaterRef entityType="production-order"
    [entityId]="selectedProductionOrderForStatusUpdate._id!"
    [currentStatus]="selectedProductionOrderForStatusUpdate.status" [availableStatuses]="productionOrderStatusOptions"
    [entityReference]="selectedProductionOrderForStatusUpdate.internalReference"
    (statusUpdated)="onStatusUpdated($event); clearStatusUpdateSelection()"
    (statusUpdateFailed)="onStatusUpdateFailed($event)">
</ds-status-updater>


<!-- Modal geral para confirma√ß√µes -->
<ds-modal modalId="general-modal">
    <app-general-modal-content></app-general-modal-content>
</ds-modal>