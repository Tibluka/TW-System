<div class="production-orders-container">

    <h1 class="title-semibold primary-dark mb-48">Ordens de produção</h1>

    <div class="search-input">
        <div class="w-100">
            <ds-input label="Buscar ordem de produção" placeholder="Digite referência, tipo de tecido ou observações..."
                icon="fa-solid fa-magnifying-glass" iconPosition="left" [(ngModel)]="currentFilters.search"
                (input)="onSearchChange()" width="100%">
            </ds-input>
        </div>

        <div class="w-100">
            <ds-select label="Filtrar por Status" [options]="statusOptions" [(ngModel)]="currentFilters.status"
                (ngModelChange)="onStatusFilterChange()" width="100%">
            </ds-select>
        </div>

        <div class="d-flex gap-16">
            <ds-button label="Limpar Filtros" variant="outline" icon="fa-solid fa-eraser"
                (onClickEmitter)="clearFilters()" [disabled]="!hasActiveFilters()">
            </ds-button>

            <ds-button label="Nova Ordem de Produção" variant="fill" icon="fa-solid fa-plus"
                (onClickEmitter)="createProductionOrder()">
            </ds-button>
        </div>
    </div>

    <div class="results mt-32">
        <ds-list-view [items]="productionOrders" [config]="listViewConfig">
            <div slot="table">
                <ds-table emptyMessage="Nenhuma ordem de produção encontrada" [showPagination]="true"
                    [pageSize]="currentFilters.limit" [totalPages]="pagination?.totalPages"
                    [currentPage]="pagination?.currentPage || 1" (pageChanged)="onPageChange($event)"
                    [loadingData]="shouldShowSpinner">


                    <ds-table-row [isHeader]="true">
                        <ds-table-cell [isHeader]="true" align="left">Imagem</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Referência Interna</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Referência do Cliente</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Cliente</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Tipo de Produção</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Tecido</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center">Status</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center">Ações</ds-table-cell>
                    </ds-table-row>


                    <ds-table-row *ngFor="let productionOrder of productionOrders" [clickable]="true"
                        [data]="productionOrder" (rowClick)="onProductionOrderClick(productionOrder)">


                        <ds-table-cell align="left">
                            <div class="image-cell">
                                <img *ngIf="productionOrder.development.pieceImage?.url"
                                    [src]="productionOrder.development.pieceImage?.url"
                                    [alt]="productionOrder.development.description || 'Imagem do desenvolvimento'"
                                    class="development-image">
                                <div *ngIf="!productionOrder.development.pieceImage?.url" class="no-image">
                                    <ds-icon icon="fa-solid fa-image" color="label" fontSize="24px"></ds-icon>
                                </div>
                            </div>
                        </ds-table-cell>


                        <ds-table-cell align="left">
                            <span class="body primary-dark">
                                <span class="body primary-dark font-weight-medium">{{
                                    productionOrder.internalReference }}</span>
                                <ds-icon (click)="copy($event, productionOrder.internalReference)" class="ml-4"
                                    cursorType="pointer" icon="fa-regular fa-clipboard" fontSize="16px" />
                            </span>
                        </ds-table-cell>


                        <ds-table-cell align="left">
                            <span class="body primary-dark">
                                {{ productionOrder.development.clientReference || '-' }}
                            </span>
                        </ds-table-cell>


                        <ds-table-cell align="left">
                            <div class="client-cell" *ngIf="productionOrder.development.client">
                                <div class="body primary-dark">
                                    {{ productionOrder.development.client.companyName }}
                                </div>
                                <div class="placeholder" *ngIf="productionOrder.development.client?.acronym">
                                    {{ productionOrder.development.client.acronym }}
                                </div>
                            </div>
                            <span class="body label" *ngIf="!productionOrder.development.client">
                                Cliente não encontrado
                            </span>
                        </ds-table-cell>


                        <ds-table-cell align="left">
                            <span class="body primary-dark" *ngIf="productionOrder.productionType.type === 'rotary'">
                                Rotativo
                            </span>
                            <span class="body primary-dark" *ngIf="productionOrder.productionType.type === 'localized'">
                                Localizado
                            </span>
                            <p class="body label" *ngIf="productionOrder.productionType.type === 'rotary'">
                                {{productionOrder.productionType.meters}}m</p>
                        </ds-table-cell>


                        <ds-table-cell align="left">
                            <span class="body primary-dark">{{ productionOrder.fabricType || '-' }}</span>
                        </ds-table-cell>


                        <ds-table-cell align="center">
                            <ds-badge [text]="getStatusLabel(productionOrder.status)" [status]="productionOrder.status"
                                entityType="production-order" />

                        </ds-table-cell>


                        <ds-table-cell align="center">
                            <ds-action-menu [items]="actionMenuItems"
                                (itemSelected)="onActionMenuSelect(productionOrder, $event)">
                            </ds-action-menu>
                        </ds-table-cell>

                    </ds-table-row>
                </ds-table>
            </div>

            <ng-template #cardTemplate let-productionOrder>
                <div class="card-content" (click)="onProductionOrderClick(productionOrder)">
                    <img *ngIf="productionOrder.development.pieceImage.url"
                        [src]="productionOrder.development.pieceImage.url" [alt]="productionOrder.internalReference"
                        class="card-image" />

                    <div class="card-body">
                        <h3 class="title-modal mb-6 mt-8 secondary">{{ productionOrder.internalReference }}</h3>

                        <p class="subtitle-section secondary" *ngIf="productionOrder.development.client.companyName">{{
                            productionOrder.development.client.companyName
                            }}</p>

                        <p class="card-small secondary mb-8" *ngIf="productionOrder.development.clientReference">{{
                            productionOrder.development.clientReference
                            }}</p>

                        <hr>

                        <h4 class="body secondary mt-8 mb-0"> {{ productionType(productionOrder.productionType!.type) }}
                        </h4>
                    </div>

                    <div class="card-actions">
                        <ds-icon icon="fa-solid fa-arrow-right-arrow-left" color="label" fontSize="20px"
                            cursorType="pointer"
                            (click)="changeProductionOrderStatus(productionOrder); $event.stopPropagation()"
                            title="Alterar Status" />

                        <ds-icon icon="fa-solid fa-trash" color="label" fontSize="20px" cursorType="pointer"
                            (click)="deleteProductionOrder(productionOrder); $event.stopPropagation()"
                            title="Excluir" />
                    </div>
                </div>
            </ng-template>

        </ds-list-view>

    </div>
</div>


<ds-modal *ngIf="isModalOpen" modalId="production-order-modal" (modalClosed)="onModalClosed($event)">
    <app-production-order-modal [productionOrderId]="selectedProductionOrderId"></app-production-order-modal>
</ds-modal>


<ds-status-updater *ngIf="selectedProductionOrderForStatusUpdate" #statusUpdaterRef entityType="production-order"
    [entityId]="selectedProductionOrderForStatusUpdate._id!"
    [currentStatus]="selectedProductionOrderForStatusUpdate.status" [availableStatuses]="productionOrderStatusOptions"
    [entityReference]="selectedProductionOrderForStatusUpdate.internalReference"
    (statusUpdated)="onStatusUpdated($event); clearStatusUpdateSelection()"
    (statusUpdateFailed)="onStatusUpdateFailed($event)">
</ds-status-updater>


<ds-modal modalId="general-modal">
    <app-general-modal-content></app-general-modal-content>
</ds-modal>