<div class="delivery-sheets-container">

    <h1 class="title-semibold primary-dark mb-48">Fichas de entrega</h1>


    <div *ngIf="successMessage" class="alert alert-success mb-24">
        <ds-icon icon="fa-solid fa-check-circle" class="mr-8"></ds-icon>
        {{ successMessage }}
    </div>

    <div *ngIf="showError" class="alert alert-error mb-24">
        <ds-icon icon="fa-solid fa-exclamation-circle" class="mr-8"></ds-icon>
        {{ errorMessage }}
    </div>


    <div class="search-input">
        <div class="search-field">
            <ds-input [fullWidth]="true" label="Buscar" placeholder="Digite referência interna, endereço..."
                icon="fa-solid fa-magnifying-glass" iconPosition="left" [(ngModel)]="currentFilters.search"
                (ngModelChange)="onSearchChange()" />
        </div>

        <div class="filters-row">
            <div class="filter-field">
                <ds-select [fullWidth]="true" label="Status" [options]="statusOptions"
                    [(ngModel)]="currentFilters.status" (ngModelChange)="onStatusFilterChange()" />
            </div>

            <div class="filter-field">
                <ds-select [fullWidth]="true" label="Cliente" [options]="clientOptions"
                    [(ngModel)]="currentFilters.clientId" (ngModelChange)="onClientFilterChange()" />
            </div>
        </div>

        <div class="date-filters">
            <div class="date-field">
                <ds-input [fullWidth]="true" label="Data Inicial" type="date"
                    [(ngModel)]="currentFilters.deliveryDateFrom" (ngModelChange)="onDateFilterChange()" />
            </div>

            <div class="date-field">
                <ds-input [fullWidth]="true" label="Data Final" type="date" [(ngModel)]="currentFilters.deliveryDateTo"
                    (ngModelChange)="onDateFilterChange()" />
            </div>
        </div>

        <div class="action-buttons">
            <ds-button label="Limpar Filtros" variant="outline" icon="fa-solid fa-eraser"
                (onClickEmitter)="clearFilters()" [disabled]="!hasActiveFilters()" class="clear-btn"
                [fullWidth]="false">
            </ds-button>

            <ds-button label="Nova Ficha de Entrega" variant="fill" icon="fa-solid fa-plus"
                (onClickEmitter)="createDeliverySheet()" class="create-btn" [fullWidth]="false">
            </ds-button>
        </div>
    </div>


    <div class="results mt-32">
        <ds-list-view [items]="deliverySheets" [config]="listViewConfig">
            <div slot="table">
                <ds-table emptyMessage="Nenhuma ficha de entrega encontrada" [showPagination]="true"
                    [pageSize]="currentFilters.limit" [totalPages]="pagination?.totalPages"
                    [currentPage]="pagination?.currentPage || 1" (pageChanged)="onPageChange($event)"
                    [loadingData]="shouldShowSpinner">

                    <ds-table-row [isHeader]="true">
                        <ds-table-cell [isHeader]="true" align="left" class="hide-mobile">Ref. Interna</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left" class="hide-mobile">Cliente</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left" class="hide-small">Endereço</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center">Data de Entrega</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center" class="hide-small">Valor Total</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center" class="hide-mobile">Nota Fiscal</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center">Status</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center">Ações</ds-table-cell>
                    </ds-table-row>

                    <ds-table-row *ngFor="let deliverySheet of deliverySheets" [clickable]="true" [data]="deliverySheet"
                        (rowClick)="onDeliverySheetClick(deliverySheet)">


                        <ds-table-cell align="left" class="hide-mobile">
                            <span class="body primary-dark">
                                <span class="body primary-dark font-weight-medium">{{
                                    deliverySheet.internalReference }}</span>
                                <ds-icon (click)="copy($event, deliverySheet.internalReference)" class="ml-4"
                                    cursorType="pointer" icon="fa-regular fa-clipboard" fontSize="16px" />
                            </span>
                        </ds-table-cell>


                        <ds-table-cell align="left" class="hide-mobile">
                            <div class="client-cell">
                                <span class="body primary-dark">
                                    {{ deliverySheet.productionSheet?.productionOrder?.development?.client?.companyName
                                    || deliverySheet.client?.companyName || '-' }}
                                </span>
                                <span class="caption secondary"
                                    *ngIf="deliverySheet.productionSheet?.productionOrder?.development?.client?.contact?.email || deliverySheet.client?.contact?.email">
                                    {{
                                    deliverySheet.productionSheet?.productionOrder?.development?.client?.contact?.email
                                    || deliverySheet.client?.contact?.email }}
                                </span>
                            </div>
                        </ds-table-cell>


                        <ds-table-cell align="left" class="hide-small">
                            <div class="address-cell">
                                <span class="body primary-dark">
                                    {{ deliverySheet.address.street }}
                                </span>
                                <span class="caption secondary">
                                    {{ deliverySheet.address.city }}, {{ deliverySheet.address.state }}
                                </span>
                            </div>
                        </ds-table-cell>


                        <ds-table-cell align="center">
                            <span class="body primary-dark" *ngIf="deliverySheet.deliveryDate; else noDeliveryDate">
                                {{ formatDate(deliverySheet.deliveryDate) }}
                            </span>
                            <ng-template #noDeliveryDate>
                                <span class="caption secondary">-</span>
                            </ng-template>
                        </ds-table-cell>


                        <ds-table-cell align="center" class="hide-small">
                            <span class="body primary-dark font-weight-medium">
                                {{ formatCurrency(deliverySheet.totalValue) }}
                            </span>
                        </ds-table-cell>


                        <ds-table-cell align="center" class="hide-mobile">
                            <span class="body secondary" *ngIf="deliverySheet.invoiceNumber; else noInvoice">
                                {{ deliverySheet.invoiceNumber }}
                            </span>
                            <ng-template #noInvoice>
                                <span class="caption secondary">-</span>
                            </ng-template>
                        </ds-table-cell>


                        <ds-table-cell align="center">
                            <ds-badge [text]="getStatusLabel(deliverySheet.status)" [status]="deliverySheet.status"
                                entityType="delivery-sheet" />
                        </ds-table-cell>


                        <ds-table-cell align="center">
                            <ds-action-menu [items]="actionMenuItems"
                                (itemSelected)="onActionMenuSelect(deliverySheet, $event)">
                            </ds-action-menu>
                        </ds-table-cell>

                    </ds-table-row>
                </ds-table>
            </div>

            <ng-template #cardTemplate let-deliverySheet>
                <div class="card-content" (click)="onDeliverySheetClick(deliverySheet)">
                    <div class="card-header">
                        <div class="card-title-section">
                            <h3 class="title-modal mb-4 secondary">{{ deliverySheet.internalReference }}</h3>
                            <ds-badge [text]="getStatusLabel(deliverySheet.status)" [status]="deliverySheet.status"
                                entityType="delivery-sheet" class="status-badge-mobile" />
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="card-info">
                            <div class="info-item"
                                *ngIf="deliverySheet.productionSheet?.productionOrder?.development?.client?.companyName || deliverySheet.client?.companyName">
                                <i class="fa-solid fa-building"></i>
                                <span>{{
                                    deliverySheet.productionSheet?.productionOrder?.development?.client?.companyName ||
                                    deliverySheet.client?.companyName }}</span>
                            </div>

                            <div class="info-item" *ngIf="deliverySheet.address?.street">
                                <i class="fa-solid fa-map-marker-alt"></i>
                                <span>{{ deliverySheet.address.street }}</span>
                            </div>

                            <div class="info-item" *ngIf="deliverySheet.address?.city && deliverySheet.address?.state">
                                <i class="fa-solid fa-city"></i>
                                <span>{{ deliverySheet.address.city }}, {{ deliverySheet.address.state }}</span>
                            </div>

                            <div class="info-item" *ngIf="deliverySheet.deliveryDate">
                                <i class="fa-solid fa-calendar-check"></i>
                                <span>Entrega: {{ formatDate(deliverySheet.deliveryDate) }}</span>
                            </div>

                            <div class="info-item" *ngIf="deliverySheet.totalValue">
                                <i class="fa-solid fa-dollar-sign"></i>
                                <span>Valor: {{ formatCurrency(deliverySheet.totalValue) }}</span>
                            </div>

                            <div class="info-item" *ngIf="deliverySheet.invoiceNumber">
                                <i class="fa-solid fa-file-invoice"></i>
                                <span>NF: {{ deliverySheet.invoiceNumber }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="card-actions">
                        <ds-icon icon="fa-solid fa-arrow-right-arrow-left" color="label" fontSize="20px"
                            cursorType="pointer"
                            (click)="changeDeliverySheetStatus(deliverySheet); $event.stopPropagation()"
                            title="Alterar Status" />

                        <ds-icon icon="fa-solid fa-trash" color="label" fontSize="20px" cursorType="pointer"
                            (click)="deleteDeliverySheet(deliverySheet); $event.stopPropagation()" title="Excluir" />
                    </div>
                </div>
            </ng-template>
        </ds-list-view>
    </div>


</div>


<ds-modal *ngIf="isModalOpen" modalId="delivery-sheet-modal" (modalClosed)="onModalClosed($event)">
    <app-delivery-sheet-modal [clients]="clients">
    </app-delivery-sheet-modal>
</ds-modal>


<ds-status-updater *ngIf="selectedDeliverySheetForStatusUpdate" #statusUpdaterRef entityType="delivery-sheet"
    [entityId]="selectedDeliverySheetForStatusUpdate._id!" [currentStatus]="selectedDeliverySheetForStatusUpdate.status"
    [availableStatuses]="deliverySheetStatusOptions"
    [entityReference]="selectedDeliverySheetForStatusUpdate.internalReference"
    (statusUpdated)="onStatusUpdated($event); clearStatusUpdateSelection()"
    (statusUpdateFailed)="onStatusUpdateFailed($event)">
</ds-status-updater>

<ds-modal modalId="general-modal">
    <app-general-modal-content></app-general-modal-content>
</ds-modal>
