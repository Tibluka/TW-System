<div class="production-sheet-modal-container">

    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-container">
        <ds-spinner size="lg" message="Carregando ficha de produção..."></ds-spinner>
    </div>

    <!-- Formulário principal -->
    <form [formGroup]="productionSheetForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading">

        <!-- Seção do formulário -->
        <div class="form-section">

            <!-- Referência Interna da Ordem de Produção -->
            <div class="field-group mb-16">
                <ds-input label="Referência Interna da Ordem" placeholder="Digite a referência interna (ex: DEV001)"
                    formControlName="internalReference" icon="fa-solid fa-search" iconPosition="left" [required]="true"
                    [errorMessage]="getFieldError('internalReference')"
                    [invalid]="isFormControlInvalid(productionSheetForm.get('internalReference'))" width="100%" />
            </div>
            <div class="search-status">

                <!-- Loading da busca -->
                <div class="text-center p-48" *ngIf="searchingProductionOrder">
                    <ds-spinner size="48px" variant="outline"></ds-spinner>
                </div>

                <!-- Referência não encontrado -->
                <div class="search-not-found" *ngIf="productionOrderNotFound">
                    <ds-icon icon="fa-solid fa-triangle-exclamation" color="tertiary" fontSize="16px"></ds-icon>
                    <span class="body tertiary ml-8">Referência não encontrada</span>
                </div>

                <!-- Desenvolvimento encontrado -->
                <div class="development-found mb-24" *ngIf="productionOrderFound && !searchingProductionOrder">
                    <p class="input-label">Resumo do desenvolvimento</p>
                    <div class="development-card">
                        <div class="image">
                            <img [src]="productionOrderFound.development?.pieceImage?.url" alt="">
                        </div>
                        <div class="development-details">
                            <h1 class="title-modal mb-6 secondary">
                                {{productionOrderFound.internalReference}}
                            </h1>
                            <p class="subtitle-section secondary mb-0">
                                {{productionOrderFound.development!.client?.companyName}}</p>
                            <p class="card-small secondary mb-4">{{productionOrderFound!.development?.clientReference}}
                            </p>
                            <hr>
                            <p class="body secondary mt-4 mb-0">
                                {{productionType(productionOrderFound!.development!.productionType!.type)}}
                            </p>
                            <h2 class="subtitle-section secondary" Ordem de produção></h2>
                            <!-- Tabela para tipo de produção localizada -->
                            <div *ngIf="productionOrderFound?.productionType!.type === 'localized'">
                                <div class="table-container"
                                    *ngIf="productionOrderFound?.productionType?.additionalInfo?.sizes && productionOrderFound.development?.productionType?.additionalInfo?.sizes!.length > 0; else noSizes">
                                    <table class="production-table">
                                        <!-- Cabeçalho com os tamanhos -->
                                        <thead>
                                            <tr>
                                                <th>
                                                    Variante
                                                    <ds-icon icon="fa-solid fa-circle-plus" cursorType="pointer"
                                                        color="tertiary" fontSize="16px" />
                                                </th>
                                                <th class="size-header"
                                                    *ngFor="let sizeItem of productionOrderFound.productionType?.additionalInfo?.sizes">
                                                    {{ sizeItem.size }}
                                                </th>
                                            </tr>
                                        </thead>

                                        <!-- Corpo com os valores -->
                                        <tbody>
                                            <tr>
                                                <td>
                                                    {{productionOrderFound.productionType.additionalInfo?.variant}}
                                                </td>
                                                <td class="size-value"
                                                    *ngFor="let sizeItem of productionOrderFound.productionType?.additionalInfo?.sizes">
                                                    <p class="body secondary">{{sizeItem.value}}</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Estado vazio -->
                                <ng-template #noSizes>
                                    <div class="empty-state">
                                        <i class="fa-solid fa-table"></i>
                                        <p>Nenhum tamanho definido para este desenvolvimento</p>
                                    </div>
                                </ng-template>
                            </div>
                            <div class="form-field" *ngIf="productionOrderFound.productionType!.type === 'rotary'">
                                <!-- 📏 QUANTIDADE DE METROS -->
                                <p class="body secondary">{{productionOrderFound.productionType!.meters}}m
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="d-grid columns-3 gap-24" *ngIf="productionOrderFound">

                <!-- Máquina -->
                <div class="field-group machine-field">
                    <ds-select label="Máquina" placeholder="Selecione a máquina" formControlName="machine"
                        [options]="machineOptions" [required]="true" [errorMessage]="getFieldError('machine')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('machine'))" width="100%" />
                </div>

                <!-- Data de Entrada -->
                <div class="field-group entry-date-field">
                    <ds-input label="Data de Entrada" placeholder="Data de início da produção"
                        formControlName="entryDate" type="date" icon="fa-solid fa-calendar" iconPosition="left"
                        [errorMessage]="getFieldError('entryDate')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('entryDate'))" width="100%" />
                </div>

                <!-- Data de Saída Prevista -->
                <div class="field-group expected-exit-date-field">
                    <ds-input label="Data de Saída Prevista" placeholder="Data prevista para conclusão"
                        formControlName="expectedExitDate" type="date" icon="fa-solid fa-calendar-check"
                        iconPosition="left" [required]="true" [errorMessage]="getFieldError('expectedExitDate')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('expectedExitDate'))" width="100%" />
                </div>

                <!-- Estágio (apenas no modo edição) -->
                <div class="field mb-24" *ngIf="isEditMode">
                    <ds-select label="Estágio da Produção" placeholder="Selecione o estágio" formControlName="stage"
                        [options]="stageOptions" [errorMessage]="getFieldError('stage')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('stage'))" width="100%" />
                </div>



            </div>
            <!-- Observações de Produção -->

            <div *ngIf="productionOrderFound || isEditMode">
                <ds-textarea label="Observações de Produção"
                    placeholder="Digite observações específicas da produção (opcional)..."
                    formControlName="productionNotes" [rows]="4" [errorMessage]="getFieldError('productionNotes')"
                    [invalid]="isFormControlInvalid(productionSheetForm.get('productionNotes'))" width="100%" />
            </div>
        </div>

        <!-- Botões de ação -->
        <div class="modal-actions mt-32" *ngIf="productionOrderFound || isEditMode">
            <ds-button label="Cancelar" variant="ghost" (onClickEmitter)="onCancel()" [disabled]="isSaving" />

            <!-- Botão especial para avançar estágio (modo edição) -->
            <ds-button type="button" *ngIf="isEditMode && canAdvanceStage()" label="Avançar Estágio" variant="outline"
                icon="fa-solid fa-arrow-right" (onClickEmitter)="onAdvanceStage($event)" [disabled]="isSaving"
                class="advance-stage-btn" />

            <ds-button label="{{ isEditMode ? 'Atualizar' : 'Criar' }} Ficha" type="submit" [isLoading]="isSaving"
                [disabled]="isSaving" />
        </div>

    </form>

</div>