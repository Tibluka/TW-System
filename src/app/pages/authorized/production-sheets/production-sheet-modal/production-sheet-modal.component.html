<div class="production-sheet-modal-container">

    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-container">
        <ds-spinner size="lg" message="Carregando ficha de produção..."></ds-spinner>
    </div>

    <!-- Formulário principal -->
    <form [formGroup]="productionSheetForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading">

        <!-- Seção do formulário -->
        <div class="form-section">

            <!-- Referência Interna da Ordem de Produção -->
            <div class="field-group mb-16">
                <ds-input label="Referência Interna da Ordem" placeholder="Digite a referência interna (ex: DEV001)"
                    formControlName="internalReference" icon="fa-solid fa-search" iconPosition="left" [required]="true"
                    [errorMessage]="getFieldError('internalReference')"
                    [invalid]="isFormControlInvalid(productionSheetForm.get('internalReference'))" width="100%" />
            </div>
            <div class="search-status">

                <!-- Loading da busca -->
                <div class="text-center p-48" *ngIf="searchingProductionOrder">
                    <ds-spinner size="48px" variant="outline"></ds-spinner>
                </div>

                <!-- Referência não encontrado -->
                <div class="search-not-found" *ngIf="productionOrderNotFound">
                    <ds-icon icon="fa-solid fa-triangle-exclamation" color="tertiary" fontSize="16px"></ds-icon>
                    <span class="body tertiary ml-8">Referência não encontrada</span>
                </div>

                <!-- Desenvolvimento encontrado -->
                <div class="development-found" *ngIf="productionOrderFound && !searchingProductionOrder">
                    <p class="input-label">Resumo do desenvolvimento</p>
                    <div class="development-card">
                        <div class="image">
                            <img [src]="productionOrderFound.development?.pieceImage?.url" alt="">
                        </div>
                        <div class="development-details">
                            <h1 class="title-modal mb-6 secondary">
                                {{productionOrderFound.development?.internalReference}}
                            </h1>
                            <p class="subtitle-section secondary mb-0">
                                {{productionOrderFound.development?.client?.companyName}}</p>
                            <p class="card-small secondary mb-4">{{productionOrderFound.development?.clientReference}}
                            </p>
                            <hr>
                            <p class="body secondary mt-4 mb-0">
                                {{productionOrderFound.development?.productionType?.type}}
                            </p>
                        </div>
                    </div>
                </div>

            </div>

            <div class="d-grid columns-3 gap-24" *ngIf="productionOrderFound">

                <!-- Máquina -->
                <div class="field-group machine-field">
                    <ds-select label="Máquina" placeholder="Selecione a máquina" formControlName="machine"
                        [options]="machineOptions" [required]="true" [errorMessage]="getFieldError('machine')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('machine'))" width="100%" />
                    <span class="helper-text">
                        Máquina onde será realizada a produção
                    </span>
                </div>

                <!-- Data de Entrada -->
                <div class="field-group entry-date-field">
                    <ds-input label="Data de Entrada" placeholder="Data de início da produção"
                        formControlName="entryDate" type="date" icon="fa-solid fa-calendar" iconPosition="left"
                        [errorMessage]="getFieldError('entryDate')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('entryDate'))" width="100%" />
                    <span class="helper-text">
                        Data em que a produção será iniciada (padrão: hoje)
                    </span>
                </div>

                <!-- Data de Saída Prevista -->
                <div class="field-group expected-exit-date-field">
                    <ds-input label="Data de Saída Prevista" placeholder="Data prevista para conclusão"
                        formControlName="expectedExitDate" type="date" icon="fa-solid fa-calendar-check"
                        iconPosition="left" [required]="true" [errorMessage]="getFieldError('expectedExitDate')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('expectedExitDate'))" width="100%" />
                    <span class="helper-text">
                        Data prevista para finalização da produção
                    </span>
                </div>

                <!-- Estágio (apenas no modo edição) -->
                <div class="field-group stage-field" *ngIf="isEditMode">
                    <ds-select label="Estágio da Produção" placeholder="Selecione o estágio" formControlName="stage"
                        [options]="stageOptions" [errorMessage]="getFieldError('stage')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('stage'))" width="100%" />
                    <span class="helper-text">
                        Estágio atual do processo produtivo
                    </span>
                </div>

                <!-- Observações de Produção -->
                <div class="field-group production-notes-field">
                    <ds-textarea label="Observações de Produção"
                        placeholder="Digite observações específicas da produção (opcional)..."
                        formControlName="productionNotes" [rows]="4" [errorMessage]="getFieldError('productionNotes')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('productionNotes'))" width="100%" />
                    <span class="helper-text">
                        Observações técnicas, configurações especiais, etc. (máximo 1000 caracteres)
                    </span>
                </div>

            </div>
        </div>

        <!-- Informações da Ordem de Produção (quando encontrada) -->
        <div class="production-order-info" *ngIf="productionOrderFound || isEditMode">
            <h3 class="section-title">
                <ds-icon icon="fa-solid fa-info-circle" color="info"></ds-icon>
                Informações da Ordem de Produção
            </h3>

            <div class="order-details-grid">
                <div class="detail-item">
                    <span class="label">Referência Interna:</span>
                    <span class="value">{{ productionOrderFound?.internalReference || 'S/N' }}</span>
                </div>

                <div class="detail-item">
                    <span class="label">Cliente:</span>
                    <span class="value">{{ productionOrderFound?.development?.client?.companyName || 'N/A' }}</span>
                </div>

                <div class="detail-item">
                    <span class="label">Tipo de Tecido:</span>
                    <span class="value">{{ productionOrderFound?.fabricType || 'N/A' }}</span>
                </div>

                <div class="detail-item">
                    <span class="label">Status:</span>
                    <span class="value status-badge"
                        [ngClass]="'status-' + productionOrderFound?.status!.toLowerCase().replace('_', '-')">
                        {{ getProductionOrderStatusLabel(productionOrderFound!.status) }}
                    </span>
                </div>

                <div class="detail-item" *ngIf="productionOrderFound?.productionType">
                    <span class="label">Tipo de Produção:</span>
                    <span class="value">
                        <span *ngIf="productionOrderFound?.productionType?.type === 'rotary'">
                            Rotativo ({{ productionOrderFound?.productionType?.meters }}m)
                        </span>
                        <span *ngIf="productionOrderFound?.productionType?.type === 'localized'">
                            Localizado
                        </span>
                    </span>
                </div>

                <div class="detail-item" *ngIf="productionOrderFound?.observations">
                    <span class="label">Observações:</span>
                    <span class="value">{{ productionOrderFound?.observations }}</span>
                </div>
            </div>
        </div>

        <!-- Botões de ação -->
        <div class="modal-actions" *ngIf="productionOrderFound || isEditMode">
            <ds-button label="Cancelar" variant="ghost" (onClickEmitter)="onCancel()" [disabled]="isSaving" />

            <!-- Botão especial para avançar estágio (modo edição) -->
            <ds-button *ngIf="isEditMode && canAdvanceStage()" label="Avançar Estágio" variant="outline"
                icon="fa-solid fa-arrow-right" (onClickEmitter)="onAdvanceStage()" [disabled]="isSaving"
                class="advance-stage-btn" />

            <ds-button label="{{ isEditMode ? 'Atualizar' : 'Criar' }} Ficha" type="submit" [isLoading]="isSaving"
                [disabled]="isSaving || productionSheetForm.invalid" />
        </div>

    </form>

</div>