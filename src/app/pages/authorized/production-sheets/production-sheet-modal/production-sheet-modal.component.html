<div class="production-sheet-modal-container">


    <div *ngIf="isLoading" class="loading-container">
        <ds-spinner size="lg" message="Carregando recibo de produção..."></ds-spinner>
    </div>

    <div class="d-flex justify-content-end" *ngIf="isEditMode">
        <ds-print-button label="Imprimir Ficha" target=".production-sheet-modal-container" [printOptions]="printOptions"
            [disabled]="isSaving" />
    </div>


    <form [formGroup]="productionSheetForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading">


        <div class="form-section">

            <div class="field-group mb-16">
                <ds-input label="Referência Interna da Ordem" placeholder="Digite a referência interna (ex: DEV001)"
                    formControlName="internalReference" icon="fa-solid fa-search" iconPosition="left" [required]="true"
                    [errorMessage]="getFieldError('internalReference')"
                    [invalid]="isFormControlInvalid(productionSheetForm.get('internalReference'))" width="100%" />
            </div>
            <div class="search-status">


                <div class="text-center p-48" *ngIf="searchingProductionOrder">
                    <ds-spinner size="48px" variant="outline"></ds-spinner>
                </div>


                <div class="search-not-found" *ngIf="productionOrderNotFound">
                    <ds-icon icon="fa-solid fa-triangle-exclamation" color="tertiary" fontSize="16px"></ds-icon>
                    <span class="body tertiary ml-8">Ordem de produção não encontrada</span>
                </div>


                <div class="development-found mb-24" *ngIf="productionOrderFound && !searchingProductionOrder">
                    <p class="input-label">Resumo da Ordem de Produção</p>
                    <div class="development-card">
                        <div class="image">
                            <img [src]="productionOrderFound.development?.pieceImage?.url" alt="">
                        </div>
                        <div class="development-details">
                            <div class="d-flex justify-content-between">
                                <h1 class="title-modal mb-6 secondary">
                                    {{productionOrderFound.internalReference}}
                                </h1>
                                <h1 class="subtitle-section tertiary align-items-center">
                                    {{productionOrderStatus(productionOrderFound.status)}}
                                </h1>
                            </div>
                            <p class="subtitle-section secondary mb-0">
                                {{productionOrderFound.development!.client?.companyName}}</p>
                            <p class="card-small secondary mb-4">{{productionOrderFound!.development?.clientReference}}
                            </p>
                            <hr>
                            <p class="body secondary mt-4 mb-4">
                                Tipo de produção:
                                {{productionType(productionOrderFound!.development!.productionType!.type)}}
                            </p>
                            <div class="form-field" *ngIf="productionOrderFound.productionType!.type === 'rotary'">

                                <p class="body secondary">{{productionOrderFound.productionType!.meters}}m
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-24" *ngIf="productionOrderFound?.productionType!.type === 'localized'">
                        <div class="table-container"
                            *ngIf="productionOrderFound?.productionType?.additionalInfo?.sizes && productionOrderFound.development?.productionType?.additionalInfo?.sizes!.length > 0; else noSizes">
                            <table class="production-table">

                                <thead>
                                    <tr>
                                        <th>
                                            Variante
                                        </th>
                                        <th class="size-header"
                                            *ngFor="let sizeItem of productionOrderFound.productionType?.additionalInfo?.sizes">
                                            {{ sizeItem.size }}
                                        </th>
                                    </tr>
                                </thead>


                                <tbody>
                                    <tr>
                                        <td>
                                            {{productionOrderFound.productionType.additionalInfo?.variant}}
                                        </td>
                                        <td class="size-value"
                                            *ngFor="let sizeItem of productionOrderFound.productionType?.additionalInfo?.sizes">
                                            <p class="body secondary">{{sizeItem.value}}</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>


                        <ng-template #noSizes>
                            <div class="empty-state">
                                <i class="fa-solid fa-table"></i>
                                <p>Nenhum tamanho definido para este desenvolvimento</p>
                            </div>
                        </ng-template>
                    </div>
                </div>

            </div>

            <div class="d-grid columns-3 gap-24" *ngIf="productionOrderFound">


                <div class="field-group machine-field">
                    <ds-select label="Máquina" placeholder="Selecione a máquina" formControlName="machine"
                        [options]="machineOptions" [required]="true" [errorMessage]="getFieldError('machine')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('machine'))" width="100%" />
                </div>


                <div class="field-group entry-date-field">
                    <ds-input label="Data de Entrada" placeholder="Data de início da produção"
                        formControlName="entryDate" type="date" icon="fa-solid fa-calendar" iconPosition="left"
                        [errorMessage]="getFieldError('entryDate')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('entryDate'))" width="100%" />
                </div>


                <div class="field-group expected-exit-date-field">
                    <ds-input label="Data de Saída Prevista" placeholder="Data prevista para conclusão"
                        formControlName="expectedExitDate" type="date" icon="fa-solid fa-calendar-check"
                        iconPosition="left" [required]="true" [errorMessage]="getFieldError('expectedExitDate')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('expectedExitDate'))" width="100%" />
                </div>

            </div>


            <div class="production-parameters-section" *ngIf="productionOrderFound || isEditMode">
                <h3 class="section-title mb-16">Parâmetros de Produção</h3>

                <div class="parameters-grid">
                    <div class="field-group temperature-field">
                        <ds-input label="Temperatura (°C)" placeholder="Ex: 180" formControlName="temperature"
                            type="number" step="0.1" min="0" max="500" icon="fa-solid fa-thermometer-half"
                            iconPosition="left" [errorMessage]="getFieldError('temperature')"
                            [invalid]="isFormControlInvalid(productionSheetForm.get('temperature'))" width="100%" />
                    </div>

                    <div class="field-group velocity-field">
                        <ds-input label="Velocidade (m/min)" placeholder="Ex: 25" formControlName="velocity"
                            type="number" step="0.1" min="0" max="1000" icon="fa-solid fa-tachometer-alt"
                            iconPosition="left" [errorMessage]="getFieldError('velocity')"
                            [invalid]="isFormControlInvalid(productionSheetForm.get('velocity'))" width="100%" />
                    </div>
                </div>
            </div>


            <div *ngIf="productionOrderFound || isEditMode">
                <ds-textarea label="Observações de Produção"
                    placeholder="Digite observações específicas da produção (opcional)..."
                    formControlName="productionNotes" [rows]="4" [errorMessage]="getFieldError('productionNotes')"
                    [invalid]="isFormControlInvalid(productionSheetForm.get('productionNotes'))" width="100%" />
            </div>
        </div>


        <div class="modal-actions mt-32" *ngIf="productionOrderFound || isEditMode">
            <ds-button label="Cancelar" variant="ghost" (onClickEmitter)="onCancel()" [disabled]="isSaving" />

            <ds-button label="{{ isEditMode ? 'Atualizar' : 'Criar' }} Ficha de Produção" type="submit"
                [isLoading]="isSaving" [disabled]="isSaving" />
        </div>

    </form>

</div>
