<div class="production-sheet-modal-container">

    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-container">
        <ds-spinner size="lg" message="Carregando recibo de produ√ß√£o..."></ds-spinner>
    </div>

    <!-- Formul√°rio principal -->
    <form [formGroup]="productionSheetForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading">

        <!-- Se√ß√£o do formul√°rio -->
        <div class="form-section">
            <!-- Refer√™ncia Interna da Ordem de Produ√ß√£o -->
            <div class="field-group mb-16">
                <ds-input label="Refer√™ncia Interna da Ordem" placeholder="Digite a refer√™ncia interna (ex: DEV001)"
                    formControlName="internalReference" icon="fa-solid fa-search" iconPosition="left" [required]="true"
                    [errorMessage]="getFieldError('internalReference')"
                    [invalid]="isFormControlInvalid(productionSheetForm.get('internalReference'))" width="100%" />
            </div>
            <div class="search-status">

                <!-- Loading da busca -->
                <div class="text-center p-48" *ngIf="searchingProductionOrder">
                    <ds-spinner size="48px" variant="outline"></ds-spinner>
                </div>

                <!-- Refer√™ncia n√£o encontrado -->
                <div class="search-not-found" *ngIf="productionOrderNotFound">
                    <ds-icon icon="fa-solid fa-triangle-exclamation" color="tertiary" fontSize="16px"></ds-icon>
                    <span class="body tertiary ml-8">Refer√™ncia n√£o encontrada</span>
                </div>

                <!-- Desenvolvimento encontrado -->
                <div class="development-found mb-24" *ngIf="productionOrderFound && !searchingProductionOrder">
                    <p class="input-label">Resumo da Ordem de Produ√ß√£o</p>
                    <div class="development-card">
                        <div class="image">
                            <img [src]="productionOrderFound.development?.pieceImage?.url" alt="">
                        </div>
                        <div class="development-details">
                            <div class="d-flex justify-content-between">
                                <h1 class="title-modal mb-6 secondary">
                                    {{productionOrderFound.internalReference}}
                                </h1>
                                <h1 class="subtitle-section tertiary align-items-center">
                                    {{productionOrderStatus(productionOrderFound.status)}}
                                </h1>
                            </div>
                            <p class="subtitle-section secondary mb-0">
                                {{productionOrderFound.development!.client?.companyName}}</p>
                            <p class="card-small secondary mb-4">{{productionOrderFound!.development?.clientReference}}
                            </p>
                            <hr>
                            <p class="body secondary mt-4 mb-4">
                                Tipo de produ√ß√£o:
                                {{productionType(productionOrderFound!.development!.productionType!.type)}}
                            </p>
                            <!-- Tabela para tipo de produ√ß√£o localizada -->
                            <div *ngIf="productionOrderFound?.productionType!.type === 'localized'">
                                <div class="table-container"
                                    *ngIf="productionOrderFound?.productionType?.additionalInfo?.sizes && productionOrderFound.development?.productionType?.additionalInfo?.sizes!.length > 0; else noSizes">
                                    <table class="production-table">
                                        <!-- Cabe√ßalho com os tamanhos -->
                                        <thead>
                                            <tr>
                                                <th>
                                                    Variante
                                                </th>
                                                <th class="size-header"
                                                    *ngFor="let sizeItem of productionOrderFound.productionType?.additionalInfo?.sizes">
                                                    {{ sizeItem.size }}
                                                </th>
                                            </tr>
                                        </thead>

                                        <!-- Corpo com os valores -->
                                        <tbody>
                                            <tr>
                                                <td>
                                                    {{productionOrderFound.productionType.additionalInfo?.variant}}
                                                </td>
                                                <td class="size-value"
                                                    *ngFor="let sizeItem of productionOrderFound.productionType?.additionalInfo?.sizes">
                                                    <p class="body secondary">{{sizeItem.value}}</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Estado vazio -->
                                <ng-template #noSizes>
                                    <div class="empty-state">
                                        <i class="fa-solid fa-table"></i>
                                        <p>Nenhum tamanho definido para este desenvolvimento</p>
                                    </div>
                                </ng-template>
                            </div>
                            <div class="form-field" *ngIf="productionOrderFound.productionType!.type === 'rotary'">
                                <!-- üìè QUANTIDADE DE METROS -->
                                <p class="body secondary">{{productionOrderFound.productionType!.meters}}m
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="d-grid columns-3 gap-24" *ngIf="productionOrderFound">

                <!-- M√°quina -->
                <div class="field-group machine-field">
                    <ds-select label="M√°quina" placeholder="Selecione a m√°quina" formControlName="machine"
                        [options]="machineOptions" [required]="true" [errorMessage]="getFieldError('machine')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('machine'))" width="100%" />
                </div>

                <!-- Data de Entrada -->
                <div class="field-group entry-date-field">
                    <ds-input label="Data de Entrada" placeholder="Data de in√≠cio da produ√ß√£o"
                        formControlName="entryDate" type="date" icon="fa-solid fa-calendar" iconPosition="left"
                        [errorMessage]="getFieldError('entryDate')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('entryDate'))" width="100%" />
                </div>

                <!-- Data de Sa√≠da Prevista -->
                <div class="field-group expected-exit-date-field">
                    <ds-input label="Data de Sa√≠da Prevista" placeholder="Data prevista para conclus√£o"
                        formControlName="expectedExitDate" type="date" icon="fa-solid fa-calendar-check"
                        iconPosition="left" [required]="true" [errorMessage]="getFieldError('expectedExitDate')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('expectedExitDate'))" width="100%" />
                </div>

                <!-- Est√°gio (apenas no modo edi√ß√£o) -->
                <div class="field mb-24" *ngIf="isEditMode">
                    <ds-select label="Est√°gio da Produ√ß√£o" placeholder="Selecione o est√°gio" formControlName="stage"
                        [options]="stageOptions" [errorMessage]="getFieldError('stage')"
                        [invalid]="isFormControlInvalid(productionSheetForm.get('stage'))" width="100%" />
                </div>



            </div>
            <!-- Observa√ß√µes de Produ√ß√£o -->

            <div *ngIf="productionOrderFound || isEditMode">
                <ds-textarea label="Observa√ß√µes de Produ√ß√£o"
                    placeholder="Digite observa√ß√µes espec√≠ficas da produ√ß√£o (opcional)..."
                    formControlName="productionNotes" [rows]="4" [errorMessage]="getFieldError('productionNotes')"
                    [invalid]="isFormControlInvalid(productionSheetForm.get('productionNotes'))" width="100%" />
            </div>
        </div>

        <!-- Bot√µes de a√ß√£o -->
        <div class="modal-actions mt-32" *ngIf="productionOrderFound || isEditMode">
            <ds-button label="Cancelar" variant="ghost" (onClickEmitter)="onCancel()" [disabled]="isSaving" />

            <ds-button label="{{ isEditMode ? 'Atualizar' : 'Criar' }} Recibo" type="submit" [isLoading]="isSaving"
                [disabled]="isSaving" />
        </div>

    </form>

</div>