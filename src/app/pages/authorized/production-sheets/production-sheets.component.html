<div class="production-sheets-container">

    <h1 class="title-semibold primary-dark mb-48">Fichas de produção</h1>


    <div class="search-input">
        <!-- Filtros Básicos -->
        <div class="w-100">
            <ds-input label="Buscar ficha de produção" placeholder="Digite referência interna, observações..."
                icon="fa-solid fa-magnifying-glass" iconPosition="left" [(ngModel)]="currentFilters.search"
                (input)="onSearchChange()" width="100%">
            </ds-input>
        </div>

        <div class="w-100">
            <ds-select label="Filtrar por Estágio" [options]="stageOptions" [(ngModel)]="currentFilters.stage"
                (ngModelChange)="onStageFilterChange()" width="100%">
            </ds-select>
        </div>

        <div class="w-100">
            <ds-select label="Filtrar por Máquina" [options]="machineOptions" [(ngModel)]="currentFilters.machine"
                (ngModelChange)="onMachineFilterChange()" width="100%">
            </ds-select>
        </div>

        <!-- Filtro de Data - Range Único (busca por data de entrada ou saída prevista) -->
        <div class="w-100 date-filter-group">
            <ds-input label="Data Inicial" type="date" [(ngModel)]="currentFilters.dateFrom"
                (ngModelChange)="onDateFilterChange()" width="100%">
            </ds-input>
        </div>

        <div class="w-100 date-filter-group">
            <ds-input label="Data Final" type="date" [(ngModel)]="currentFilters.dateTo"
                (ngModelChange)="onDateFilterChange()" width="100%">
            </ds-input>
        </div>

        <!-- Botão de Ação -->
        <ds-button label="Nova Ficha de Produção" variant="fill" icon="fa-solid fa-plus"
            (onClickEmitter)="createProductionSheet()">
        </ds-button>
    </div>


    <div class="results mt-32">
        <ds-list-view [items]="productionSheets" [config]="listViewConfig" [loading]="loading"
            emptyMessage="Nenhuma ficha de produção encontrada">
            <div slot="table">
                <ds-table emptyMessage="Nenhuma ficha de produção encontrada" [showPagination]="true"
                    [pageSize]="currentFilters.limit" [totalPages]="pagination?.totalPages"
                    [currentPage]="pagination?.currentPage || 1" (pageChanged)="onPageChange($event)"
                    [loadingData]="loading">


                    <ds-table-row [isHeader]="true">
                        <ds-table-cell [isHeader]="true" align="left">Imagem</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Ref. Interna</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Ref. do Cliente</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Cliente</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center">Máquina</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Entrada</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="left">Saída Prevista</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center">Estágio</ds-table-cell>
                        <ds-table-cell [isHeader]="true" align="center">Ações</ds-table-cell>
                    </ds-table-row>


                    <ds-table-row *ngFor="let productionSheet of productionSheets" [clickable]="true"
                        [data]="productionSheet" (rowClick)="onProductionSheetClick(productionSheet)">


                        <ds-table-cell align="left">
                            <div class="image-cell">
                                <img *ngIf="productionSheet.productionOrder?.development?.pieceImage?.url"
                                    [src]="productionSheet.productionOrder?.development?.pieceImage?.url"
                                    [alt]="productionSheet.productionOrder?.development?.description || 'Imagem do desenvolvimento'"
                                    class="development-image">
                                <div *ngIf="!productionSheet.productionOrder?.development?.pieceImage?.url"
                                    class="no-image">
                                    <ds-icon icon="fa-solid fa-image" color="label" fontSize="24px"></ds-icon>
                                </div>
                            </div>
                        </ds-table-cell>


                        <ds-table-cell align="left">
                            <span class="body primary-dark font-weight-medium">{{
                                productionSheet.internalReference }}</span>
                            <ds-icon (click)="copy($event, productionSheet.productionOrder!.internalReference)"
                                class="ml-4" cursorType="pointer" icon="fa-regular fa-clipboard" fontSize="16px" />

                        </ds-table-cell>


                        <ds-table-cell align="left">
                            <span class="body primary-dark">
                                {{ productionSheet.productionOrder?.development?.clientReference || '-' }}
                            </span>
                        </ds-table-cell>


                        <ds-table-cell align="left">
                            <div class="client-cell" *ngIf="productionSheet.productionOrder?.development?.client">
                                <div class="body primary-dark">
                                    {{ productionSheet.productionOrder?.development?.client?.companyName }}
                                </div>
                                <div class="placeholder"
                                    *ngIf="productionSheet.productionOrder?.development?.client?.acronym">
                                    {{ productionSheet.productionOrder?.development?.client?.acronym }}
                                </div>
                            </div>
                            <span class="body label" *ngIf="!productionSheet.productionOrder?.development?.client">
                                Cliente não encontrado
                            </span>
                        </ds-table-cell>


                        <ds-table-cell align="center">
                            <div class="machine-cell">
                                <ds-icon icon="fa-solid fa-cogs" color="primary" fontSize="16px"></ds-icon>
                                <span class="body primary-dark ml-8">
                                    {{ getMachineName(productionSheet.machine) }}
                                </span>
                            </div>
                        </ds-table-cell>


                        <ds-table-cell align="left">
                            <span class="body primary-dark">
                                {{ formatDate(productionSheet.entryDate) }}
                            </span>
                        </ds-table-cell>

                        <ds-table-cell align="left">
                            <span class="body primary-dark">
                                {{ formatDate(productionSheet.expectedExitDate) }}
                            </span>
                        </ds-table-cell>


                        <ds-table-cell align="center">
                            <ds-badge [text]="getStageLabel(productionSheet.stage)" [status]="productionSheet.stage"
                                entityType="production-sheet" />
                        </ds-table-cell>


                        <ds-table-cell align="center">
                            <ds-action-menu [items]="getActionMenuItems(productionSheet)"
                                (itemSelected)="onActionMenuSelect(productionSheet, $event)">
                            </ds-action-menu>
                        </ds-table-cell>

                    </ds-table-row>
                </ds-table>
            </div>

            <ng-template #cardTemplate let-productionSheet>
                <div class="card-content" (click)="onProductionSheetClick(productionSheet)">
                    <img *ngIf="productionSheet.productionOrder?.development?.pieceImage?.url"
                        [src]="productionSheet.productionOrder?.development?.pieceImage?.url"
                        [alt]="productionSheet.internalReference" class="card-image" />

                    <div class="card-body">
                        <h3 class="title-modal mb-6 mt-8 secondary">{{ productionSheet.internalReference }}</h3>

                        <p class="subtitle-section secondary"
                            *ngIf="productionSheet.productionOrder?.development?.client?.companyName">{{
                            productionSheet.productionOrder?.development?.client?.companyName
                            }}</p>

                        <p class="card-small secondary mb-8"
                            *ngIf="productionSheet.productionOrder?.development?.clientReference">{{
                            productionSheet.productionOrder?.development?.clientReference
                            }}</p>

                        <hr>

                        <h4 class="body secondary mt-8 mb-0">Máquina {{ getMachineName(productionSheet.machine) }}</h4>
                    </div>

                    <div class="card-actions">
                        <ds-icon icon="fa-solid fa-arrow-right-arrow-left" color="label" fontSize="20px"
                            cursorType="pointer"
                            (click)="changeProductionSheetStatus(productionSheet); $event.stopPropagation()"
                            title="Alterar Estágio" />

                        <ds-icon icon="fa-solid fa-trash" color="label" fontSize="20px" cursorType="pointer"
                            (click)="deleteProductionSheet(productionSheet); $event.stopPropagation()"
                            title="Excluir" />
                    </div>
                </div>
            </ng-template>

        </ds-list-view>
    </div>


    <ds-modal modalId="production-sheet-modal" *ngIf="isModalOpen" (modalClosed)="onModalClosed($event)">
        <app-production-sheet-modal></app-production-sheet-modal>
    </ds-modal>


    <ds-status-updater *ngIf="selectedProductionSheetForStatusUpdate" #statusUpdaterRef entityType="production-sheet"
        [entityId]="selectedProductionSheetForStatusUpdate._id!"
        [currentStatus]="selectedProductionSheetForStatusUpdate.stage" [availableStatuses]="productionSheetStageOptions"
        [entityReference]="selectedProductionSheetForStatusUpdate.internalReference"
        (statusUpdated)="onStatusUpdated($event); clearStatusUpdateSelection()"
        (statusUpdateFailed)="onStatusUpdateFailed($event)">
    </ds-status-updater>


    <ds-modal modalId="general-modal">
        <app-general-modal-content></app-general-modal-content>
    </ds-modal>

</div>